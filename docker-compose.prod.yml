version: '3.9'

# Production docker-compose - uses pre-built images from GCP Artifact Registry
# Deploy with: docker-compose -f docker-compose.prod.yml up -d

services:
  vgtpbx-switch:
    image: northamerica-northeast1-docker.pkg.dev/dev-vgtpbx/vgtpbx-switch-docker/vgtpbx-switch:${VERSION:-latest}
    container_name: vgtpbx-switch
    network_mode: "host"
    environment:
      - POSTGRES_HOST=vgtpbx-postgres
      - SWITCH_DB_NAME=freeswitch
      - SWITCH_DB_USER=freeswitch
      - SWITCH_DB_PASSWORD=insecure12345
      - FS_STARTUP_OPTIMIZATION=true
      - FREESWITCH_LOG_LEVEL=debug
    volumes:
      - vgtpbx-freeswitch-config:/etc/vgtpbx/freeswitch
      - vgtpbx-freeswitch-recordings:/etc/vgtpbx/media/fs/recordings
      - vgtpbx-freeswitch-storage:/etc/vgtpbx/media/fs/storage
      - vgtpbx-freeswitch-log:/var/log/freeswitch
    tmpfs:
      - /var/lib/freeswitch/db:size=256m,noexec,nosuid,nodev
    ports:
      - "5060:5060/udp"
      - "5060:5060/tcp"
      - "5061:5061/tcp"
      - "5080:5080/udp"
      - "5080:5080/tcp"
      - "5066:5066/tcp"
      - "7443:7443/tcp"
      - "8021:8021/tcp"
    healthcheck:
      test: ["CMD", "fs_cli", "-x", "status"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    cap_add:
      - SYS_NICE
      - NET_ADMIN
      - NET_RAW
      - SYS_RESOURCE
      - IPC_LOCK
    security_opt:
      - seccomp:unconfined
    ulimits:
      nproc: 65535
      nofile:
        soft: 999999
        hard: 999999
      core:
        soft: -1
        hard: -1
      memlock:
        soft: -1
        hard: -1
      rtprio:
        soft: 99
        hard: 99
    deploy:
      resources:
        limits:
          memory: 650M
        reservations:
          memory: 400M

  vgtpbx-eslserver:
    image: northamerica-northeast1-docker.pkg.dev/dev-vgtpbx/vgtpbx-switch-docker/vgtpbx-eslserver:${VERSION:-latest}
    container_name: vgtpbx-eslserver
    network_mode: "host"
    environment:
      - FREESWITCH_HOST=127.0.0.1
      - FREESWITCH_ESL_PORT=8021
      - FREESWITCH_ESL_PASSWORD=ClueCon
      - NEXTJS_INTERNAL_API_URL=http://10.162.0.53:3000/api/httpapihandler
      - API_PORT=8081
      - NODE_ENV=production
    restart: unless-stopped
    # NOTE: No depends_on - ESL server runs independently
    # Provides monitoring and auto-reconnects when FreeSWITCH recovers
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:8081/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 200M
        reservations:
          memory: 50M

volumes:
  vgtpbx-freeswitch-config:
    name: vgtpbx-freeswitch-config
  vgtpbx-freeswitch-recordings:
    name: vgtpbx-freeswitch-recordings
  vgtpbx-freeswitch-storage:
    name: vgtpbx-freeswitch-storage
  vgtpbx-freeswitch-log:
    name: vgtpbx-freeswitch-log
