# syntax=docker/dockerfile:1.2
version: '3.9'

services:
  vgtpbx-switch:
    profiles: ["small", "medium", "large"]
    build:
      context: .
      dockerfile: ${DOCKERFILE:-Dockerfile.small}
      args:
        - SIGNALWIRE_TOKEN
      secrets:
        - signalwire_token
    image: vgtpbx-switch:${SIZE:-small}
    container_name: vgtpbx-switch
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=${POSTGRES_DB:-vgtpbx}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - FS_STARTUP_OPTIMIZATION=true
      - FREESWITCH_LOG_LEVEL=debug
    volumes:
      - freeswitch-config:/etc/vgtpbx/freeswitch
      - freeswitch-recordings:/etc/vgtpbx/media/fs/recordings
      - freeswitch-storage:/etc/vgtpbx/media/fs/storage
      - freeswitch-log:/var/log/freeswitch
      - freeswitch-db:/var/lib/freeswitch/db
    ports:
      - "5060:5060/udp"  # SIP UDP
      - "5060:5060/tcp"  # SIP TCP
      - "5061:5061/tcp"  # SIP TLS
      - "5080:5080/udp"  # SIP UDP Alternative
      - "5080:5080/tcp"  # SIP TCP Alternative
      - "5066:5066/tcp"  # WebSocket for WebRTC
      - "7443:7443/tcp"  # WebSocket TLS for WebRTC
      - "8021:8021/tcp"  # Event Socket
      - "16384-32768:16384-32768/udp"  # RTP Media
    healthcheck:
      test: ["CMD-SHELL", "fs_cli -x 'status' | grep -q 'UP' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s  
    restart: unless-stopped
    networks:
      - vgtpbx-network
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  freeswitch-config:
  freeswitch-recordings:
  freeswitch-storage:
  freeswitch-log:
  freeswitch-db:

networks:
  vgtpbx-network:
    external: false

secrets:
  signalwire_token:
    environment: SIGNALWIRE_TOKEN